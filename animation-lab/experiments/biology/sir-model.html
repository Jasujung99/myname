<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실험: SIR 전염병 모델 시뮬레이션</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            color: white;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .main-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        .simulation-container {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #simulation-view {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        .side-panel {
            width: 300px;
            flex-shrink: 0;
            background-color: #2a2a2e;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }
        .panel-header h1 {
            font-size: 1.5rem;
            margin: 0;
            color: #fff;
        }
        .info-box {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .info-box h3 {
            margin-top: 0;
            color: #4a9eff;
            font-size: 1rem;
        }
        .status-legend {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .status-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .status-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .susceptible { background-color: #0ea5e9; }
        .infected { background-color: #ef4444; }
        .recovered { background-color: #6b7280; }
        
        .control-section {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .control-section h3 {
            margin-top: 0;
            color: #4a9eff;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #controls-view {
            margin-bottom: 20px;
        }
        #controls-view .vega-bind {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        #controls-view .vega-bind-name {
            font-weight: 500;
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        #controls-view .vega-bind-value {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        #controls-view input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .sim-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .sim-controls button {
            background-color: #4a4a4f;
            color: white;
            border: 1px solid #666;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
        }
        .sim-controls button:hover {
            background-color: #5a5a5f;
        }
        .sim-controls button.play {
            background-color: #28a745;
        }
        .sim-controls button.play:hover {
            background-color: #218838;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .side-panel {
                width: 100%;
                height: auto;
                border-left: none;
                border-top: 1px solid #444;
                max-height: 40vh;
            }
            .simulation-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="simulation-container">
            <div id="simulation-view"></div>
        </div>
        <div class="side-panel">
            <div class="panel-header">
                <h1>🦠 SIR 전염병 모델</h1>
            </div>
            
            <div class="info-box">
                <h3>📊 상태 범례</h3>
                <div class="status-legend">
                    <div class="status-item">
                        <div class="status-color susceptible"></div>
                        <span>감수성자 (S)</span>
                    </div>
                    <div class="status-item">
                        <div class="status-color infected"></div>
                        <span>감염자 (I)</span>
                    </div>
                    <div class="status-item">
                        <div class="status-color recovered"></div>
                        <span>회복자 (R)</span>
                    </div>
                </div>
                <p style="font-size: 0.85rem; color: #ccc; margin: 0;">
                    개체들이 자유롭게 이동하며 감염이 확산되는 과정을 관찰하세요.
                </p>
            </div>

            <div class="control-section">
                <h3>🎛️ 방역 정책 설정</h3>
                <div id="controls-view"></div>
                
                <div class="sim-controls">
                    <button id="play-pause-btn" class="play">시작</button>
                    <button id="reset-btn">초기화</button>
                </div>
            </div>
        </div>
    </div>

<script type="text/javascript">

// ========== 1. 명세(Spec) 정의 ==========

const mainSpec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "autosize": {"type": "fit", "resize": true},
  "background": "#000",

  "data": [
    { 
      "name": "nodes",
    }
  ],

  "signals": [
    { "name": "timer", "value": 0 }, 
    { "name": "population", "value": 200 },
    { "name": "infection_rate", "value": 0.8 },
    { "name": "recovery_duration", "value": 150 },
    { "name": "social_distancing", "value": 12 },
    { "name": "movement_speed", "value": 2 },
  ],

  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": ["S", "I", "R"],
      "range": ["#0ea5e9", "#ef4444", "#6b7280"]
    },
    {
      "name": "size",
      "type": "ordinal", 
      "domain": ["S", "I", "R"],
      "range": [60, 80, 50]
    }
  ],

  "marks": [
    {
      "name": "node_marks",
      "type": "symbol",
      "from": {"data": "nodes"},
      "encode": {
        "update": {
          "size": {"scale": "size", "field": "status"},
          "fill": {"scale": "color", "field": "status"},
          "stroke": {"value": "white"},
          "strokeWidth": [
            {
              "test": "datum.status === 'I'",
              "value": 2
            },
            {"value": 0.5}
          ],
          "opacity": [
            {
              "test": "datum.status === 'I'",
              "value": 1
            },
            {"value": 0.85}
          ],
          "x": {"field": "x"},
          "y": {"field": "y"}
        }
      },
      "transform": [
        { 
          "type": "force",
          "iterations": 1,
          "static": false,
          "restart": true,
          "forces": [
            {"force": "center", "x": {"signal": "width/2"}, "y": {"signal": "height/2"}, "strength": 0.05},
            {"force": "collide", "radius": {"signal": "social_distancing"}, "strength": 0.3}, 
            {"force": "nbody", "strength": -2, "theta": 0.9}
          ]
        }
      ]
    }
  ]
};

const controlsSpec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "padding": 5, "background": "transparent",
  "signals": [
    { "name": "population", "value": 200, "bind": {"name": "총 인구 수", "input": "range", "min": 50, "max": 400, "step": 10} },
    { "name": "infection_rate", "value": 0.8, "bind": {"name": "감염률 (β)", "input": "range", "min": 0.1, "max": 2.0, "step": 0.1} },
    { "name": "recovery_duration", "value": 150, "bind": {"name": "회복 기간 (프레임)", "input": "range", "min": 50, "max": 400, "step": 10} },
    { "name": "social_distancing", "value": 12, "bind": {"name": "사회적 거리두기", "input": "range", "min": 5, "max": 25, "step": 1} },
    { "name": "movement_speed", "value": 2, "bind": {"name": "이동 속도", "input": "range", "min": 0.5, "max": 5, "step": 0.1} }
  ]
};

// ========== 2. Vega 뷰(View) 생성 및 연동 ==========

(async () => {
  let mainView, controlsView;
  let population = 200;
  
  let timerId = null; 
  let isPaused = true;

  try {
    const controlsResult = await vegaEmbed('#controls-view', controlsSpec, {actions: false});
    controlsView = controlsResult.view;
    
    const mainResult = await vegaEmbed('#simulation-view', mainSpec, {actions: false});
    mainView = mainResult.view;
    
    const playPauseBtn = document.getElementById('play-pause-btn');
    const resetBtn = document.getElementById('reset-btn');

    function generateInitialData(popCount) {
      const nodes = [];
      // 동적 캔버스 크기 가져오기
      const simulationElement = document.getElementById('simulation-view');
      const width = simulationElement ? simulationElement.clientWidth : 800;
      const height = simulationElement ? simulationElement.clientHeight : 600;
      const centerX = width / 2;
      const centerY = height / 2;
      const clusterRadius = Math.min(width, height) * 0.12; // 더 작은 클러스터
      
      for (let i = 0; i < popCount; i++) {
        let x, y;
        
        if (i < 8) {
          // 더 많은 감염자를 정중앙에 배치
          const angle = (i / 8) * 2 * Math.PI;
          const r = Math.random() * 25; // 중심에서 25px 반경 내로 줄임
          x = centerX + r * Math.cos(angle);
          y = centerY + r * Math.sin(angle);
        } else {
          // 나머지는 중앙 주변 원형으로 밀집 배치
          const angle = Math.random() * 2 * Math.PI;
          const r = Math.random() * clusterRadius;
          x = centerX + r * Math.cos(angle);
          y = centerY + r * Math.sin(angle);
        }
        
        // 정확히 중앙에 위치하도록 조정
        nodes.push({
          id: i,
          status: i < 8 ? 'I' : 'S',
          infection_timer: i < 8 ? 1 : 0,
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 0.8, // 초기 속도 더 줄임
          vy: (Math.random() - 0.5) * 0.8
        });
      }
      return nodes;
    }
    
    function setupControlListeners() {
        const signals = ['infection_rate', 'recovery_duration', 'social_distancing', 'movement_speed'];
        signals.forEach(sigName => {
            controlsView.addSignalListener(sigName, (name, value) => {
                mainView.signal(name, value).runAsync();
            });
        });
        
        controlsView.addSignalListener('population', (name, value) => {
            if (population !== value) {
                population = value;
                resetSimulation();
            }
        });
    }

    function playSimulation() {
        if (timerId) return;
        timerId = setInterval(() => {
            const currentNodes = mainView.data('nodes');
            const infectionRate = mainView.signal('infection_rate');
            const recoveryDuration = mainView.signal('recovery_duration');
            const movementSpeed = mainView.signal('movement_speed') || 2;
            const socialDistance = mainView.signal('social_distancing');

            // 동적 캔버스 크기 가져오기
            const simulationElement = document.getElementById('simulation-view');
            const width = simulationElement ? simulationElement.clientWidth : 800;
            const height = simulationElement ? simulationElement.clientHeight : 600;

            // 새로운 노드 상태 계산 (이동 + 감염 + 회복)
            const newNodes = currentNodes.map(node => {
                let newStatus = node.status;
                let newTimer = node.infection_timer;

                // 1. 개선된 중앙 집중 + 랜덤 이동 로직
                const centerX = width / 2;
                const centerY = height / 2;
                const dx = centerX - (node.x || centerX);
                const dy = centerY - (node.y || centerY);
                const distanceFromCenter = Math.sqrt(dx * dx + dy * dy);
                
                // 중앙으로 향하는 힘 - 거리에 따라 조정
                const maxDistance = Math.min(width, height) * 0.3;
                const centerForce = distanceFromCenter > maxDistance ? 0.08 : 0.01;
                
                let newVx = (node.vx || 0) + dx * centerForce + (Math.random() - 0.5) * 0.8;
                let newVy = (node.vy || 0) + dy * centerForce + (Math.random() - 0.5) * 0.8;
                
                // 속도 제한
                const speed = Math.sqrt(newVx * newVx + newVy * newVy);
                if (speed > movementSpeed) {
                    newVx = (newVx / speed) * movementSpeed;
                    newVy = (newVy / speed) * movementSpeed;
                }

                let newX = (node.x || centerX) + newVx;
                let newY = (node.y || centerY) + newVy;

                // 부드러운 경계 처리 (리플렉션)
                const margin = 40;
                if (newX <= margin) {
                    newVx = Math.abs(newVx) * 0.7;
                    newX = margin;
                } else if (newX >= width - margin) {
                    newVx = -Math.abs(newVx) * 0.7;
                    newX = width - margin;
                }
                
                if (newY <= margin) {
                    newVy = Math.abs(newVy) * 0.7;
                    newY = margin;
                } else if (newY >= height - margin) {
                    newVy = -Math.abs(newVy) * 0.7;
                    newY = height - margin;
                }

                // 2. 회복 로직
                if (node.status === 'I') {
                    if (node.infection_timer >= recoveryDuration) {
                        newStatus = 'R';
                        newTimer = 0;
                    } else {
                        newTimer = node.infection_timer + 1;
                    }
                }

                // 3. 극적으로 개선된 감염 로직 (매우 높은 확률)
                if (node.status === 'S') {
                    for (let other of currentNodes) {
                        if (other.status === 'I' && other.id !== node.id) {
                            const dx = (node.x || 0) - (other.x || 0);
                            const dy = (node.y || 0) - (other.y || 0);
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            // 감염 범위 내에 있으면 감염 확률 계산
                            const infectionRange = socialDistance * 2.0;
                            if (distance < infectionRange) {
                                // 거리가 가까울수록 감염 확률 높아짐
                                const proximityFactor = Math.max(0.1, 1 - (distance / infectionRange));
                                const baseInfectionChance = infectionRate * 0.3; // 매 프레임 30% 기본 감염 확률
                                const finalInfectionChance = baseInfectionChance * proximityFactor;
                                
                                if (Math.random() < finalInfectionChance) {
                                    newStatus = 'I';
                                    newTimer = 1;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                return { 
                    ...node, 
                    status: newStatus, 
                    infection_timer: newTimer,
                    x: newX,
                    y: newY,
                    vx: newVx,
                    vy: newVy
                };
            });

            mainView.data('nodes', newNodes).runAsync();
        }, 100); // 100ms 마다로 조정하여 변화를 더 명확히 관찰할 수 있도록
        
        isPaused = false;
        playPauseBtn.textContent = '일시정지';
        playPauseBtn.classList.remove('play');
    }

    function pauseSimulation() {
        clearInterval(timerId);
        timerId = null;
        isPaused = true;
        playPauseBtn.textContent = '시작';
        playPauseBtn.classList.add('play');
    }

    function resetSimulation() {
        pauseSimulation();
        const initialNodes = generateInitialData(population);
        
        // mainView의 신호값을 컨트롤러의 현재값으로 동기화
        mainView.signal('population', controlsView.signal('population'));
        mainView.signal('infection_rate', controlsView.signal('infection_rate'));
        mainView.signal('recovery_duration', controlsView.signal('recovery_duration'));
        mainView.signal('social_distancing', controlsView.signal('social_distancing'));
        mainView.signal('movement_speed', controlsView.signal('movement_speed'));

        mainView.data('nodes', initialNodes).runAsync();
    }
    
    playPauseBtn.addEventListener('click', () => {
        if (isPaused) {
            playSimulation();
        } else {
            pauseSimulation();
        }
    });

    resetBtn.addEventListener('click', () => {
        // 컨트롤 패널의 값을 초기값으로 되돌림
        controlsView.signal('population', 200)
                    .signal('infection_rate', 0.8)
                    .signal('recovery_duration', 150)
                    .signal('social_distancing', 12)
                    .signal('movement_speed', 2)
                    .runAsync();
        population = 200;
        resetSimulation();
    });

    // 초기 설정
    setupControlListeners();
    resetSimulation();
    
  } catch(error) {
      console.error("Vega 시뮬레이션 초기화 실패:", error);
      document.body.innerHTML = "<h3 style='color:red; text-align:center; padding-top: 50px;'>시뮬레이션을 불러오는 데 실패했습니다. 콘솔 로그를 확인해주세요.</h3>";
  }

})().catch(console.error);

</script>
</body>
</html>
