<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤í—˜: SIR ì „ì—¼ë³‘ ëª¨ë¸ ì‹œë®¬ë ˆì´ì…˜</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            color: white;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .main-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        .simulation-container {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #simulation-view {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        #simulation-view canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .side-panel {
            width: 300px;
            flex-shrink: 0;
            background-color: #2a2a2e;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }
        .panel-header h1 {
            font-size: 1.5rem;
            margin: 0;
            color: #fff;
        }
        .info-box {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .info-box h3 {
            margin-top: 0;
            color: #4a9eff;
            font-size: 1rem;
        }
        .status-legend {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .status-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .status-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .susceptible { background-color: #0ea5e9; }
        .infected { background-color: #ef4444; }
        .recovered { background-color: #6b7280; }
        
        .control-section {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .control-section h3 {
            margin-top: 0;
            color: #4a9eff;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #controls-view {
            margin-bottom: 20px;
        }
        #controls-view .vega-bind {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        #controls-view .vega-bind-name {
            font-weight: 500;
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        #controls-view .vega-bind-value {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        #controls-view input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .sim-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .sim-controls button {
            background-color: #4a4a4f;
            color: white;
            border: 1px solid #666;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
        }
        .sim-controls button:hover {
            background-color: #5a5a5f;
        }
        .sim-controls button.play {
            background-color: #28a745;
        }
        .sim-controls button.play:hover {
            background-color: #218838;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .side-panel {
                width: 100%;
                height: auto;
                border-left: none;
                border-top: 1px solid #444;
                max-height: 40vh;
            }
            .simulation-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="simulation-container">
            <div id="simulation-view"></div>
        </div>
        <div class="side-panel">
            <div class="panel-header">
                <h1>ğŸ¦  SIR ì „ì—¼ë³‘ ëª¨ë¸</h1>
            </div>
            
            <div class="info-box">
                <h3>ğŸ“Š ìƒíƒœ ë²”ë¡€</h3>
                <div class="status-legend">
                    <div class="status-item">
                        <div class="status-color susceptible"></div>
                        <span>ê°ìˆ˜ì„±ì (S)</span>
                    </div>
                    <div class="status-item">
                        <div class="status-color infected"></div>
                        <span>ê°ì—¼ì (I)</span>
                    </div>
                    <div class="status-item">
                        <div class="status-color recovered"></div>
                        <span>íšŒë³µì (R)</span>
                    </div>
                </div>
                <p style="font-size: 0.85rem; color: #ccc; margin: 0;">
                    ê°œì²´ë“¤ì´ ììœ ë¡­ê²Œ ì´ë™í•˜ë©° ê°ì—¼ì´ í™•ì‚°ë˜ëŠ” ê³¼ì •ì„ ê´€ì°°í•˜ì„¸ìš”.
                </p>
            </div>

            <div class="control-section">
                <h3>ğŸ›ï¸ ë°©ì—­ ì •ì±… ì„¤ì •</h3>
                <div id="controls-view"></div>
                
                <div class="sim-controls">
                    <button id="play-pause-btn" class="play">ì‹œì‘</button>
                    <button id="reset-btn">ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>
    </div>

<script type="text/javascript">

// ========== 1. ëª…ì„¸(Spec) ì •ì˜ ==========

const mainSpec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": {"signal": "containerWidth"},
  "height": {"signal": "containerHeight"},  
  "autosize": {"type": "none"},
  "background": "#000",

  "data": [
    { 
      "name": "nodes",
    },
    {
      "name": "infected_nodes",
      "source": "nodes",
      "transform": [
        {"type": "filter", "expr": "datum.status === 'I'"}
      ]
    },
    {
      "name": "virus_particles",
      "source": "infected_nodes",
      "transform": [
        {
          "type": "formula",
          "expr": "[0, 1, 2, 3, 4, 5, 6, 7]",
          "as": "particle_indices"
        },
        {
          "type": "flatten",
          "fields": ["particle_indices"],
          "as": ["particle_index"]
        },
        {
          "type": "formula",
          "expr": "datum.particle_index * PI / 4",
          "as": "angle"
        },
        {
          "type": "formula",
          "expr": "((timer + datum.id * 3) % 30) * 1.5",
          "as": "distance"
        },
        {
          "type": "formula",
          "expr": "max(0, 1 - datum.distance / 45)",
          "as": "particle_opacity"
        },
        {
          "type": "formula",
          "expr": "datum.x + cos(datum.angle) * datum.distance",
          "as": "particle_x"
        },
        {
          "type": "formula",
          "expr": "datum.y + sin(datum.angle) * datum.distance",
          "as": "particle_y"
        }
      ]
    }
  ],

  "signals": [
    { "name": "containerWidth", "value": 800 },
    { "name": "containerHeight", "value": 600 },
    { "name": "timer", "value": 0 }, 
    { "name": "population", "value": 200 },
    { "name": "infection_rate", "value": 0.8 },
    { "name": "recovery_duration", "value": 150 },
    { "name": "social_distancing", "value": 12 },
    { "name": "movement_speed", "value": 2 },
    { "name": "infected_count", "update": "length(data('infected_nodes'))" }
  ],

  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": ["S", "I", "R"],
      "range": ["#0ea5e9", "#ef4444", "#6b7280"]
    },
    {
      "name": "size",
      "type": "ordinal", 
      "domain": ["S", "I", "R"],
      "range": [60, 80, 50]
    }
  ],

  "marks": [
    {
      "name": "virus_aura",
      "type": "symbol",
      "from": {"data": "infected_nodes"},
      "encode": {
        "update": {
          "x": {"field": "x"},
          "y": {"field": "y"},
          "size": {"signal": "social_distancing * social_distancing * 8"},
          "fill": {"value": "rgba(255, 68, 68, 0.15)"},
          "stroke": {"value": "rgba(255, 68, 68, 0.4)"},
          "strokeWidth": {"value": 1},
          "strokeDash": {"value": [3, 3]},
          "opacity": [
            {
              "test": "datum.infection_timer % 10 < 5",
              "value": 0.8
            },
            {"value": 0.4}
          ]
        }
      }
    },
    {
      "name": "virus_particles_marks",
      "type": "symbol",
      "from": {"data": "virus_particles"},
      "encode": {
        "update": {
          "x": {"field": "particle_x"},
          "y": {"field": "particle_y"},
          "size": {"signal": "15 + sin(timer * 0.5) * 5"},
          "fill": {"value": "#ff4444"},
          "stroke": {"value": "#ff6666"},
          "strokeWidth": {"value": 0.5},
          "opacity": {"field": "particle_opacity"}
        }
      }
    },
    {
      "name": "node_marks",
      "type": "symbol",
      "from": {"data": "nodes"},
      "encode": {
        "update": {
          "size": {"scale": "size", "field": "status"},
          "fill": {"scale": "color", "field": "status"},
          "stroke": {"value": "white"},
          "strokeWidth": [
            {
              "test": "datum.status === 'I'",
              "value": 2
            },
            {"value": 0.5}
          ],
          "opacity": [
            {
              "test": "datum.status === 'I'",
              "value": 1
            },
            {"value": 0.85}
          ],
          "x": {"field": "x"},
          "y": {"field": "y"}
        }
      },
      "transform": [
        {
          "type": "formula",
          "expr": "datum.status === 'I' && datum.infection_timer >= recovery_duration ? 'R' : datum.status",
          "as": "status"
        },
        {
          "type": "formula", 
          "expr": "datum.status === 'I' ? datum.infection_timer + 1 : datum.infection_timer",
          "as": "infection_timer"
        },
        {
          "type": "formula",
          "expr": "datum.status === 'S' && infected_count > 0 && random() < (infection_rate * infected_count / population * 0.1) ? 'I' : datum.status",
          "as": "status"
        },
        {
          "type": "formula",
          "expr": "datum.status === 'I' && datum.infection_timer === 0 ? 1 : datum.infection_timer",
          "as": "infection_timer"
        },
        { 
          "type": "force",
          "iterations": 1,
          "static": false,
          "restart": true,
          "forces": [
            {"force": "center", "x": {"signal": "containerWidth/2"}, "y": {"signal": "containerHeight/2"}, "strength": 0.05},
            {"force": "collide", "radius": {"signal": "social_distancing"}, "strength": 0.3}, 
            {"force": "nbody", "strength": -2, "theta": 0.9}
          ]
        }
      ]
    }
  ]
};

const controlsSpec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "padding": 5, "background": "transparent",
  "signals": [
    { "name": "population", "value": 200, "bind": {"name": "ì´ ì¸êµ¬ ìˆ˜", "input": "range", "min": 50, "max": 400, "step": 10} },
    { "name": "infection_rate", "value": 0.8, "bind": {"name": "ê°ì—¼ë¥  (Î²)", "input": "range", "min": 0.1, "max": 2.0, "step": 0.1} },
    { "name": "recovery_duration", "value": 150, "bind": {"name": "íšŒë³µ ê¸°ê°„ (í”„ë ˆì„)", "input": "range", "min": 50, "max": 400, "step": 10} },
    { "name": "social_distancing", "value": 12, "bind": {"name": "ì‚¬íšŒì  ê±°ë¦¬ë‘ê¸°", "input": "range", "min": 5, "max": 25, "step": 1} },
    { "name": "movement_speed", "value": 2, "bind": {"name": "ì´ë™ ì†ë„", "input": "range", "min": 0.5, "max": 5, "step": 0.1} }
  ]
};

// ========== 2. Vega ë·°(View) ìƒì„± ë° ì—°ë™ ==========

(async () => {
  let mainView, controlsView;
  let population = 200;
  
  let timerId = null; 
  let isPaused = true;

  try {
    const controlsResult = await vegaEmbed('#controls-view', controlsSpec, {actions: false});
    controlsView = controlsResult.view;
    
    // ì»¨í…Œì´ë„ˆ í¬ê¸° ê°ì§€ ë° ì„¤ì •
    const simulationElement = document.getElementById('simulation-view');
    const containerWidth = simulationElement.clientWidth || 800;
    const containerHeight = simulationElement.clientHeight || 600;
    
    // ë©”ì¸ ìŠ¤í™ì— í¬ê¸° ì„¤ì •
    mainSpec.signals.find(s => s.name === 'containerWidth').value = containerWidth;
    mainSpec.signals.find(s => s.name === 'containerHeight').value = containerHeight;
    
    const mainResult = await vegaEmbed('#simulation-view', mainSpec, {actions: false});
    mainView = mainResult.view;
    
    // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    window.addEventListener('resize', () => {
      const newWidth = simulationElement.clientWidth || 800;
      const newHeight = simulationElement.clientHeight || 600;
      mainView.signal('containerWidth', newWidth)
              .signal('containerHeight', newHeight)
              .runAsync();
    });
    
    const playPauseBtn = document.getElementById('play-pause-btn');
    const resetBtn = document.getElementById('reset-btn');

    function generateInitialData(popCount) {
      const nodes = [];
      // í˜„ì¬ ì»¨í…Œì´ë„ˆ í¬ê¸° ë˜ëŠ” Vega ì‹ í˜¸ê°’ ê°€ì ¸ì˜¤ê¸°
      const width = mainView ? mainView.signal('containerWidth') : 800;
      const height = mainView ? mainView.signal('containerHeight') : 600;
      const centerX = width / 2;
      const centerY = height / 2;
      const clusterRadius = Math.min(width, height) * 0.12; // ë” ì‘ì€ í´ëŸ¬ìŠ¤í„°
      
      for (let i = 0; i < popCount; i++) {
        let x, y;
        
        if (i < 8) {
          // ë” ë§ì€ ê°ì—¼ìë¥¼ ì •ì¤‘ì•™ì— ë°°ì¹˜
          const angle = (i / 8) * 2 * Math.PI;
          const r = Math.random() * 25; // ì¤‘ì‹¬ì—ì„œ 25px ë°˜ê²½ ë‚´ë¡œ ì¤„ì„
          x = centerX + r * Math.cos(angle);
          y = centerY + r * Math.sin(angle);
        } else {
          // ë‚˜ë¨¸ì§€ëŠ” ì¤‘ì•™ ì£¼ë³€ ì›í˜•ìœ¼ë¡œ ë°€ì§‘ ë°°ì¹˜
          const angle = Math.random() * 2 * Math.PI;
          const r = Math.random() * clusterRadius;
          x = centerX + r * Math.cos(angle);
          y = centerY + r * Math.sin(angle);
        }
        
        // ì •í™•íˆ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì •
        nodes.push({
          id: i,
          status: i < 8 ? 'I' : 'S',
          infection_timer: i < 8 ? 1 : 0,
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 0.8, // ì´ˆê¸° ì†ë„ ë” ì¤„ì„
          vy: (Math.random() - 0.5) * 0.8
        });
      }
      return nodes;
    }
    
    function setupControlListeners() {
        const signals = ['infection_rate', 'recovery_duration', 'social_distancing', 'movement_speed'];
        signals.forEach(sigName => {
            controlsView.addSignalListener(sigName, (name, value) => {
                mainView.signal(name, value).runAsync();
            });
        });
        
        controlsView.addSignalListener('population', (name, value) => {
            if (population !== value) {
                population = value;
                resetSimulation();
            }
        });
    }

    function playSimulation() {
        if (timerId) return;
        timerId = setInterval(() => {
            // Vegaê°€ ëª¨ë“  ê°ì—¼/íšŒë³µ ë¡œì§ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ
            // JavaScriptëŠ” ë‹¨ìˆœíˆ íƒ€ì´ë¨¸ ì‹ í˜¸ë§Œ ì—…ë°ì´íŠ¸
            const currentTimer = mainView.signal('timer');
            mainView.signal('timer', currentTimer + 1).runAsync();
        }, 100); // 100ms ë§ˆë‹¤ ì—…ë°ì´íŠ¸
        
        isPaused = false;
        playPauseBtn.textContent = 'ì¼ì‹œì •ì§€';
        playPauseBtn.classList.remove('play');
    }

    function pauseSimulation() {
        clearInterval(timerId);
        timerId = null;
        isPaused = true;
        playPauseBtn.textContent = 'ì‹œì‘';
        playPauseBtn.classList.add('play');
    }

    function resetSimulation() {
        pauseSimulation();
        const initialNodes = generateInitialData(population);
        
        // mainViewì˜ ì‹ í˜¸ê°’ì„ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í˜„ì¬ê°’ìœ¼ë¡œ ë™ê¸°í™”
        mainView.signal('population', controlsView.signal('population'));
        mainView.signal('infection_rate', controlsView.signal('infection_rate'));
        mainView.signal('recovery_duration', controlsView.signal('recovery_duration'));
        mainView.signal('social_distancing', controlsView.signal('social_distancing'));
        mainView.signal('movement_speed', controlsView.signal('movement_speed'));

        mainView.data('nodes', initialNodes).runAsync();
    }
    
    playPauseBtn.addEventListener('click', () => {
        if (isPaused) {
            playSimulation();
        } else {
            pauseSimulation();
        }
    });

    resetBtn.addEventListener('click', () => {
        // ì»¨íŠ¸ë¡¤ íŒ¨ë„ì˜ ê°’ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
        controlsView.signal('population', 200)
                    .signal('infection_rate', 0.8)
                    .signal('recovery_duration', 150)
                    .signal('social_distancing', 12)
                    .signal('movement_speed', 2)
                    .runAsync();
        population = 200;
        resetSimulation();
    });

    // ì´ˆê¸° ì„¤ì •
    setupControlListeners();
    resetSimulation();
    
  } catch(error) {
      console.error("Vega ì‹œë®¬ë ˆì´ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
      document.body.innerHTML = "<h3 style='color:red; text-align:center; padding-top: 50px;'>ì‹œë®¬ë ˆì´ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</h3>";
  }

})().catch(console.error);

</script>
</body>
</html>
