<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïã§Ìóò: SIR Ï†ÑÏóºÎ≥ë Î™®Îç∏ ÏãúÎÆ¨Î†àÏù¥ÏÖò</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            color: white;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        .main-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        .simulation-container {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }
        #simulation-view {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        #simulation-view canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .side-panel {
            width: 300px;
            flex-shrink: 0;
            background-color: #2a2a2e;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }
        .panel-header h1 {
            font-size: 1.5rem;
            margin: 0;
            color: #fff;
        }
        .info-box {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .info-box h3 {
            margin-top: 0;
            color: #4a9eff;
            font-size: 1rem;
        }
        .status-legend {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .status-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .status-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .susceptible { background-color: #0ea5e9; }
        .infected { background-color: #ef4444; }
        .recovered { background-color: #6b7280; }
        
        .control-section {
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .control-section h3 {
            margin-top: 0;
            color: #4a9eff;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #controls-view {
            margin-bottom: 20px;
        }
        #controls-view .vega-bind {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        #controls-view .vega-bind-name {
            font-weight: 500;
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        #controls-view .vega-bind-value {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        #controls-view input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .sim-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .sim-controls button {
            background-color: #4a4a4f;
            color: white;
            border: 1px solid #666;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
        }
        .sim-controls button:hover {
            background-color: #5a5a5f;
        }
        .sim-controls button.play {
            background-color: #28a745;
        }
        .sim-controls button.play:hover {
            background-color: #218838;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .side-panel {
                width: 100%;
                height: auto;
                border-left: none;
                border-top: 1px solid #444;
                max-height: 40vh;
            }
            .simulation-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="simulation-container">
            <div id="simulation-view"></div>
        </div>
        <div class="side-panel">
            <div class="panel-header">
                <h1>ü¶† SIR Ï†ÑÏóºÎ≥ë Î™®Îç∏</h1>
            </div>
            
            <div class="info-box">
                <h3>üìä ÏÉÅÌÉú Î≤îÎ°Ä</h3>
                <div class="status-legend">
                    <div class="status-item">
                        <div class="status-color susceptible"></div>
                        <span>Í∞êÏàòÏÑ±Ïûê (S)</span>
                    </div>
                    <div class="status-item">
                        <div class="status-color infected"></div>
                        <span>Í∞êÏóºÏûê (I)</span>
                    </div>
                    <div class="status-item">
                        <div class="status-color recovered"></div>
                        <span>ÌöåÎ≥µÏûê (R)</span>
                    </div>
                </div>
                <p style="font-size: 0.85rem; color: #ccc; margin: 0;">
                    Í∞úÏ≤¥Îì§Ïù¥ ÏûêÏú†Î°≠Í≤å Ïù¥ÎèôÌïòÎ©∞ Í∞êÏóºÏù¥ ÌôïÏÇ∞ÎêòÎäî Í≥ºÏ†ïÏùÑ Í¥ÄÏ∞∞ÌïòÏÑ∏Ïöî.
                </p>
            </div>

            <div class="control-section">
                <h3>üéõÔ∏è Î∞©Ïó≠ Ï†ïÏ±Ö ÏÑ§Ï†ï</h3>
                <div id="controls-view"></div>
                
                <div class="sim-controls">
                    <button id="play-pause-btn" class="play">ÏãúÏûë</button>
                    <button id="reset-btn">Ï¥àÍ∏∞Ìôî</button>
                </div>
            </div>
        </div>
    </div>

<script type="text/javascript">

// ========== 1. Î™ÖÏÑ∏(Spec) Ï†ïÏùò ==========

const mainSpec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": {"signal": "containerWidth"},
  "height": {"signal": "containerHeight"},  
  "autosize": {"type": "none"},
  "background": "#000",

  "data": [
    { 
      "name": "nodes",
    },
    {
      "name": "infected_nodes",
      "source": "nodes",
      "transform": [
        {"type": "filter", "expr": "datum.status === 'I'"}
      ]
    },
    {
      "name": "virus_particles",
      "source": "infected_nodes",
      "transform": [
        {
          "type": "formula",
          "expr": "[0, 1, 2, 3, 4, 5, 6, 7]",
          "as": "particle_indices"
        },
        {
          "type": "flatten",
          "fields": ["particle_indices"],
          "as": ["particle_index"]
        },
        {
          "type": "formula",
          "expr": "datum.particle_index * PI / 4",
          "as": "angle"
        },
        {
          "type": "formula",
          "expr": "((timer + datum.id * 3) % 30) * 1.5",
          "as": "distance"
        },
        {
          "type": "formula",
          "expr": "max(0, 1 - datum.distance / 45)",
          "as": "particle_opacity"
        },
        {
          "type": "formula",
          "expr": "datum.x + cos(datum.angle) * datum.distance",
          "as": "particle_x"
        },
        {
          "type": "formula",
          "expr": "datum.y + sin(datum.angle) * datum.distance",
          "as": "particle_y"
        }
      ]
    }
  ],

  "signals": [
    { "name": "containerWidth", "value": 800 },
    { "name": "containerHeight", "value": 600 },
    { "name": "timer", "value": 0 }, 
    { "name": "population", "value": 200 },
    { "name": "infection_rate", "value": 0.8 },
    { "name": "recovery_duration", "value": 150 },
    { "name": "social_distancing", "value": 12 },
    { "name": "movement_speed", "value": 2 },
    { "name": "infected_count", "update": "length(data('infected_nodes'))" }
  ],

  "scales": [
    {
      "name": "color",
      "type": "ordinal",
      "domain": ["S", "I", "R"],
      "range": ["#0ea5e9", "#ef4444", "#6b7280"]
    },
    {
      "name": "size",
      "type": "ordinal", 
      "domain": ["S", "I", "R"],
      "range": [60, 80, 50]
    }
  ],

  "marks": [
    {
      "name": "virus_aura",
      "type": "symbol",
      "from": {"data": "infected_nodes"},
      "encode": {
        "update": {
          "x": {"field": "x"},
          "y": {"field": "y"},
          "size": {"signal": "social_distancing * social_distancing * 8"},
          "fill": {"value": "rgba(255, 68, 68, 0.15)"},
          "stroke": {"value": "rgba(255, 68, 68, 0.4)"},
          "strokeWidth": {"value": 1},
          "strokeDash": {"value": [3, 3]},
          "opacity": [
            {
              "test": "datum.infection_timer % 10 < 5",
              "value": 0.8
            },
            {"value": 0.4}
          ]
        }
      }
    },
    {
      "name": "virus_particles_marks",
      "type": "symbol",
      "from": {"data": "virus_particles"},
      "encode": {
        "update": {
          "x": {"field": "particle_x"},
          "y": {"field": "particle_y"},
          "size": {"signal": "15 + sin(timer * 0.5) * 5"},
          "fill": {"value": "#ff4444"},
          "stroke": {"value": "#ff6666"},
          "strokeWidth": {"value": 0.5},
          "opacity": {"field": "particle_opacity"}
        }
      }
    },
    {
      "name": "node_marks",
      "type": "symbol",
      "from": {"data": "nodes"},
      "encode": {
        "update": {
          "size": {"scale": "size", "field": "status"},
          "fill": {"scale": "color", "field": "status"},
          "stroke": {"value": "white"},
          "strokeWidth": [
            {
              "test": "datum.status === 'I'",
              "value": 2
            },
            {"value": 0.5}
          ],
          "opacity": [
            {
              "test": "datum.status === 'I'",
              "value": 1
            },
            {"value": 0.85}
          ],
          "x": {"field": "x"},
          "y": {"field": "y"}
        }
      },
      "transform": [
        {
          "type": "formula",
          "expr": "datum.status === 'I' && datum.infection_timer >= recovery_duration ? 'R' : datum.status",
          "as": "status"
        },
        {
          "type": "formula", 
          "expr": "datum.status === 'I' ? datum.infection_timer + 1 : datum.infection_timer",
          "as": "infection_timer"
        },
        {
          "type": "formula",
          "expr": "datum.status === 'S' && infected_count > 0 && random() < (infection_rate * infected_count / population * 0.1) ? 'I' : datum.status",
          "as": "status"
        },
        {
          "type": "formula",
          "expr": "datum.status === 'I' && datum.infection_timer === 0 ? 1 : datum.infection_timer",
          "as": "infection_timer"
        },
        { 
          "type": "force",
          "iterations": 1,
          "static": false,
          "restart": true,
          "forces": [
            {"force": "center", "x": {"signal": "containerWidth/2"}, "y": {"signal": "containerHeight/2"}, "strength": 0.05},
            {"force": "collide", "radius": {"signal": "social_distancing"}, "strength": 0.3}, 
            {"force": "nbody", "strength": -2, "theta": 0.9}
          ]
        }
      ]
    }
  ]
};

const controlsSpec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "padding": 5, "background": "transparent",
  "signals": [
    { "name": "population", "value": 200, "bind": {"name": "Ï¥ù Ïù∏Íµ¨ Ïàò", "input": "range", "min": 50, "max": 400, "step": 10} },
    { "name": "infection_rate", "value": 0.8, "bind": {"name": "Í∞êÏóºÎ•† (Œ≤)", "input": "range", "min": 0.1, "max": 2.0, "step": 0.1} },
    { "name": "recovery_duration", "value": 150, "bind": {"name": "ÌöåÎ≥µ Í∏∞Í∞Ñ (ÌîÑÎ†àÏûÑ)", "input": "range", "min": 50, "max": 400, "step": 10} },
    { "name": "social_distancing", "value": 12, "bind": {"name": "ÏÇ¨ÌöåÏ†Å Í±∞Î¶¨ÎëêÍ∏∞", "input": "range", "min": 5, "max": 25, "step": 1} },
    { "name": "movement_speed", "value": 2, "bind": {"name": "Ïù¥Îèô ÏÜçÎèÑ", "input": "range", "min": 0.5, "max": 5, "step": 0.1} }
  ]
};

// ========== 2. Vega Î∑∞(View) ÏÉùÏÑ± Î∞è Ïó∞Îèô ==========

(async () => {
  let mainView, controlsView;
  let population = 200;
  
  let timerId = null; 
  let isPaused = true;

  try {
    const controlsResult = await vegaEmbed('#controls-view', controlsSpec, {actions: false});
    controlsView = controlsResult.view;
    
    // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ Í∞êÏßÄ Î∞è ÏÑ§Ï†ï
    const simulationElement = document.getElementById('simulation-view');
    const containerWidth = simulationElement.clientWidth || 800;
    const containerHeight = simulationElement.clientHeight || 600;
    
    // Î©îÏù∏ Ïä§ÌéôÏóê ÌÅ¨Í∏∞ ÏÑ§Ï†ï
    mainSpec.signals.find(s => s.name === 'containerWidth').value = containerWidth;
    mainSpec.signals.find(s => s.name === 'containerHeight').value = containerHeight;
    
    const mainResult = await vegaEmbed('#simulation-view', mainSpec, {actions: false});
    mainView = mainResult.view;
    
    // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    window.addEventListener('resize', () => {
      const newWidth = simulationElement.clientWidth || 800;
      const newHeight = simulationElement.clientHeight || 600;
      mainView.signal('containerWidth', newWidth)
              .signal('containerHeight', newHeight)
              .runAsync();
    });
    
    const playPauseBtn = document.getElementById('play-pause-btn');
    const resetBtn = document.getElementById('reset-btn');

    function generateInitialData(popCount) {
      const nodes = [];
      // ÌòÑÏû¨ Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ ÎòêÎäî Vega Ïã†Ìò∏Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
      const width = mainView ? mainView.signal('containerWidth') : 800;
      const height = mainView ? mainView.signal('containerHeight') : 600;
      const centerX = width / 2;
      const centerY = height / 2;
      const clusterRadius = Math.min(width, height) * 0.12; // Îçî ÏûëÏùÄ ÌÅ¥Îü¨Ïä§ÌÑ∞
      
      for (let i = 0; i < popCount; i++) {
        let x, y;
        
        if (i < 8) {
          // Îçî ÎßéÏùÄ Í∞êÏóºÏûêÎ•º Ï†ïÏ§ëÏïôÏóê Î∞∞Ïπò
          const angle = (i / 8) * 2 * Math.PI;
          const r = Math.random() * 25; // Ï§ëÏã¨ÏóêÏÑú 25px Î∞òÍ≤Ω ÎÇ¥Î°ú Ï§ÑÏûÑ
          x = centerX + r * Math.cos(angle);
          y = centerY + r * Math.sin(angle);
        } else {
          // ÎÇòÎ®∏ÏßÄÎäî Ï§ëÏïô Ï£ºÎ≥Ä ÏõêÌòïÏúºÎ°ú Î∞ÄÏßë Î∞∞Ïπò
          const angle = Math.random() * 2 * Math.PI;
          const r = Math.random() * clusterRadius;
          x = centerX + r * Math.cos(angle);
          y = centerY + r * Math.sin(angle);
        }
        
        // Ï†ïÌôïÌûà Ï§ëÏïôÏóê ÏúÑÏπòÌïòÎèÑÎ°ù Ï°∞Ï†ï
        nodes.push({
          id: i,
          status: i < 8 ? 'I' : 'S',
          infection_timer: i < 8 ? 1 : 0,
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 0.8, // Ï¥àÍ∏∞ ÏÜçÎèÑ Îçî Ï§ÑÏûÑ
          vy: (Math.random() - 0.5) * 0.8
        });
      }
      return nodes;
    }
    
    function setupControlListeners() {
        const signals = ['infection_rate', 'recovery_duration', 'social_distancing', 'movement_speed'];
        signals.forEach(sigName => {
            controlsView.addSignalListener(sigName, (name, value) => {
                mainView.signal(name, value).runAsync();
            });
        });
        
        controlsView.addSignalListener('population', (name, value) => {
            if (population !== value) {
                population = value;
                resetSimulation();
            }
        });
    }

    function playSimulation() {
        if (timerId) return;
        timerId = setInterval(() => {
            // VegaÍ∞Ä Î™®Îì† Í∞êÏóº/ÌöåÎ≥µ Î°úÏßÅÏùÑ Ï≤òÎ¶¨ÌïòÎØÄÎ°ú
            // JavaScriptÎäî Îã®ÏàúÌûà ÌÉÄÏù¥Î®∏ Ïã†Ìò∏Îßå ÏóÖÎç∞Ïù¥Ìä∏
            const currentTimer = mainView.signal('timer');
            mainView.signal('timer', currentTimer + 1).runAsync();
        }, 100); // 100ms ÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
        
        isPaused = false;
        playPauseBtn.textContent = 'ÏùºÏãúÏ†ïÏßÄ';
        playPauseBtn.classList.remove('play');
    }

    function pauseSimulation() {
        clearInterval(timerId);
        timerId = null;
        isPaused = true;
        playPauseBtn.textContent = 'ÏãúÏûë';
        playPauseBtn.classList.add('play');
    }

    function resetSimulation() {
        pauseSimulation();
        const initialNodes = generateInitialData(population);
        
        // mainViewÏùò Ïã†Ìò∏Í∞íÏùÑ Ïª®Ìä∏Î°§Îü¨Ïùò ÌòÑÏû¨Í∞íÏúºÎ°ú ÎèôÍ∏∞Ìôî
        mainView.signal('population', controlsView.signal('population'));
        mainView.signal('infection_rate', controlsView.signal('infection_rate'));
        mainView.signal('recovery_duration', controlsView.signal('recovery_duration'));
        mainView.signal('social_distancing', controlsView.signal('social_distancing'));
        mainView.signal('movement_speed', controlsView.signal('movement_speed'));

        mainView.data('nodes', initialNodes).runAsync();
    }
    
    playPauseBtn.addEventListener('click', () => {
        if (isPaused) {
            playSimulation();
        } else {
            pauseSimulation();
        }
    });

    resetBtn.addEventListener('click', () => {
        // Ïª®Ìä∏Î°§ Ìå®ÎÑêÏùò Í∞íÏùÑ Ï¥àÍ∏∞Í∞íÏúºÎ°ú ÎêòÎèåÎ¶º
        controlsView.signal('population', 200)
                    .signal('infection_rate', 0.8)
                    .signal('recovery_duration', 150)
                    .signal('social_distancing', 12)
                    .signal('movement_speed', 2)
                    .runAsync();
        population = 200;
        resetSimulation();
    });

    // Ï¥àÍ∏∞ ÏÑ§Ï†ï
    setupControlListeners();
    resetSimulation();
    
  } catch(error) {
      console.error("Vega ÏãúÎÆ¨Î†àÏù¥ÏÖò Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", error);
      document.body.innerHTML = "<h3 style='color:red; text-align:center; padding-top: 50px;'>ÏãúÎÆ¨Î†àÏù¥ÏÖòÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏΩòÏÜî Î°úÍ∑∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</h3>";
  }

})().catch(console.error);

</script>
</body>
</html>
