<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    #vis {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="vis"></div>

  <script>
    const spec = {
      "$schema": "https://vega.github.io/schema/vega/v5.json",
      "width": 800,
      "height": 600,
      "padding": 5,
      "autosize": "none",
      
      "signals": [
        { 
          "name": "cx", 
          "update": "width / 2" 
        },
        { 
          "name": "cy", 
          "update": "height / 2" 
        },
        {
          "name": "nodeRadius",
          "value": 15
        },
        {
          "name": "nodeCharge",
          "value": -60
        },
        {
          "name": "linkDistance",
          "value": 100
        },
        {
          "name": "static",
          "value": true
        },
        {
          "name": "dragging",
          "value": false,
          "on": [
            {"events": "@nodes:mousedown", "update": "true"},
            {"events": "window:mouseup", "update": "false"}
          ]
        },
        {
          "name": "draggedNode",
          "value": null,
          "on": [
            {"events": "@nodes:mousedown", "update": "datum"},
            {"events": "window:mouseup", "update": "null"}
          ]
        },
        {
          "name": "dragPosition",
          "value": [0, 0],
          "on": [
            {
              "events": "[@nodes:mousedown, window:mouseup] > window:mousemove",
              "update": "dragging ? [x(), y()] : dragPosition"
            }
          ]
        },
        {
          "name": "restart",
          "update": "static",
          "on": [
            {"events": {"signal": "dragging"}, "update": "dragging"}
          ]
        }
      ],
      
      "data": [
        {
          "name": "node-data",
          "values": [
            {"id": "1", "name": "노드 1", "group": 1},
            {"id": "2", "name": "노드 2", "group": 2},
            {"id": "3", "name": "노드 3", "group": 1},
            {"id": "4", "name": "노드 4", "group": 3},
            {"id": "5", "name": "노드 5", "group": 2},
            {"id": "6", "name": "노드 6", "group": 3}
          ],
          "transform": [
            {
              "type": "force",
              "iterations": 300,
              "restart": {"signal": "restart"},
              "static": {"signal": "static"},
              "signal": "force",
              "forces": [
                {"force": "center", "x": {"signal": "cx"}, "y": {"signal": "cy"}},
                {"force": "collide", "radius": {"signal": "nodeRadius"}, "iterations": 2},
                {"force": "nbody", "strength": {"signal": "nodeCharge"}},
                {"force": "link", "links": "link-data", "distance": {"signal": "linkDistance"}}
              ]
            }
          ]
        },
        {
          "name": "link-data",
          "values": [
            {"source": "1", "target": "2", "value": 1},
            {"source": "2", "target": "3", "value": 1},
            {"source": "3", "target": "4", "value": 1},
            {"source": "4", "target": "5", "value": 1},
            {"source": "5", "target": "6", "value": 1},
            {"source": "6", "target": "1", "value": 1}
          ]
        }
      ],
      
      "scales": [
        {
          "name": "color",
          "type": "ordinal",
          "domain": {"data": "node-data", "field": "group"},
          "range": {"scheme": "category10"}
        }
      ],
      
      "marks": [
        {
          "type": "path",
          "from": {"data": "link-data"},
          "encode": {
            "update": {
              "stroke": {"value": "#ccc"},
              "strokeWidth": {"value": 1.5}
            }
          },
          "transform": [
            {
              "type": "linkpath",
              "shape": "line",
              "sourceX": {"field": "source.x"},
              "sourceY": {"field": "source.y"},
              "targetX": {"field": "target.x"},
              "targetY": {"field": "target.y"}
            }
          ]
        },
        {
          "name": "nodes",
          "type": "symbol",
          "from": {"data": "node-data"},
          "encode": {
            "enter": {
              "fill": {"scale": "color", "field": "group"},
              "stroke": {"value": "white"},
              "strokeWidth": {"value": 1.5}
            },
            "update": {
              "x": {"field": "x"},
              "y": {"field": "y"},
              "size": {"value": 600},
              "cursor": {"value": "pointer"},
              "fill": [
                {
                  "test": "dragging && datum === draggedNode",
                  "value": "red"
                },
                {
                  "scale": "color", 
                  "field": "group"
                }
              ]
            }
          },
          "transform": [
            {
              "type": "formula",
              "expr": "dragging && datum === draggedNode ? dragPosition[0] : datum.x",
              "as": "x"
            },
            {
              "type": "formula",
              "expr": "dragging && datum === draggedNode ? dragPosition[1] : datum.y",
              "as": "y"
            }
          ]
        },
        {
          "type": "text",
          "from": {"data": "node-data"},
          "encode": {
            "enter": {
              "fontSize": {"value": 12},
              "fontWeight": {"value": "bold"},
              "fill": {"value": "black"},
              "align": {"value": "center"},
              "baseline": {"value": "middle"},
              "text": {"field": "name"}
            },
            "update": {
              "x": {"field": "x"},
              "y": {"field": "y", "offset": 25}
            }
          }
        }
      ]
    };

    vegaEmbed('#vis', spec)
      .then(result => {
        // 뷰 인스턴스에 접근
        const view = result.view;
        
        // 외부에서 노드 추가 기능 예시
        window.addNode = function() {
          const nodeData = view.data('node-data');
          const newId = (nodeData.length + 1).toString();
          const group = Math.ceil(Math.random() * 3);
          
          // 새 노드 추가
          view.insert('node-data', {
            "id": newId,
            "name": `노드 ${newId}`,
            "group": group
          }).run();
          
          // 새 링크 추가 (마지막 노드와 연결)
          if (nodeData.length > 0) {
            const lastNode = nodeData[nodeData.length - 1].id;
            view.insert('link-data', {
              "source": lastNode,
              "target": newId,
              "value": 1
            }).run();
          }
          
          // 시뮬레이션 재시작
          view.signal('static', false).run();
          setTimeout(() => view.signal('static', true).run(), 1000);
        };
        
        console.log('Vega-Embed 결과:', result);
      })
      .catch(console.error);
  </script>
  
  <!-- 테스트용 버튼 추가 -->
  <div style="position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px;">
    <button onclick="addNode()">노드 추가</button>
  </div>
</body>
</html>
