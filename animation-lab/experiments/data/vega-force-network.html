<!DOCTYPE html>
<html>
  <head>
    <title>Vega Force-Directed Graph on Canvas - Definitive Fix</title>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: sans-serif;
        background-color: #f9f9f9;
      }
      #vis-container {
        max-width: 700px;
        margin: 0 auto;
        border: 1px solid #ddd;
        background-color: white;
      }
    </style>
  </head>
  <body>
    <h1>Vega 시각화 웹앱 예제 (액션 기능 직접 구현)</h1>
    <div id="vis-container">
      <div id="vis"></div>
    </div>
    <script type="text/javascript">
      const spec = {
        "$schema": "https://vega.github.io/schema/vega/v5.json",
        "description": "A node-link diagram with robust link drawing and fully functional embed actions.",
        "width": 700,
        "height": 500,
        "padding": 0,
        "autosize": "none",
        "data": [
          {
            "name": "node-data",
            "values": [
              {"id": "A", "group": 1},
              {"id": "B", "group": 1},
              {"id": "C", "group": 2},
              {"id": "D", "group": 2}
            ]
          },
          {
            "name": "link-data",
            "values": [
              {"source": 0, "target": 1},
              {"source": 1, "target": 2},
              {"source": 2, "target": 3},
              {"source": 3, "target": 0}
            ]
          }
        ],
        "scales": [
          {
            "name": "color",
            "type": "ordinal",
            "domain": {"data": "node-data", "field": "group"},
            "range": {"scheme": "category20c"}
          }
        ],
        "marks": [
          {
            "name": "nodes",
            "type": "symbol",
            "from": {"data": "node-data"},
            "encode": {
              "enter": {
                "fill": {"scale": "color", "field": "group"},
                "stroke": {"value": "white"},
                "size": {"value": 200}
              },
              "update": {
                "x": {"field": "x"},
                "y": {"field": "y"},
                "cursor": {"value": "pointer"}
              }
            },
            "transform": [
              {
                "type": "force",
                "iterations": 300,
                "static": false,
                "forces": [
                  {"force": "center", "x": {"signal": "width/2"}, "y": {"signal": "height/2"}},
                  {"force": "collide", "radius": 10},
                  {"force": "nbody", "strength": -50},
                  {"force": "link", "links": "link-data", "distance": 50}
                ]
              }
            ]
          },
          {
            "type": "path",
            "from": {"data": "link-data"},
            "interactive": false,
            "encode": {
              "update": {
                "stroke": {"value": "#ccc"},
                "strokeWidth": {"value": 1},
                "path": {
                  "signal": "datum.source && datum.target && isFinite(datum.source.x) ? 'M' + datum.source.x + ',' + datum.source.y + 'L' + datum.target.x + ',' + datum.target.y : ''"
                }
              }
            }
          }
        ]
      };

      // ==================
      // custom action 함수 정의
      // ==================
      const viewSource = (event) => {
        // 이벤트 객체가 있을 때만 방지 처리
        if (event && event.preventDefault) event.preventDefault();
        const specString = JSON.stringify(spec, null, 2);
        const win = window.open('');
        win.document.write('<title>Vega Source</title><pre>' + specString + '</pre>');
      };

      const openInEditor = (event) => {
        if (event && event.preventDefault) event.preventDefault();
        const editorUrl = 'https://vega.github.io/editor/';
        const form = document.createElement('form');
        form.action = editorUrl;
        form.method = 'POST';
        form.target = '_blank';
        const specInput = document.createElement('input');
        specInput.type = 'hidden';
        specInput.name = 'spec';
        specInput.value = JSON.stringify(spec);
        form.appendChild(specInput);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
      };

      const options = {
        renderer: 'canvas',
        actions: {
          export: true,
          source: viewSource,
          editor: openInEditor
        }
      };

      // VegaEmbed를 호출하여 실행합니다.
      vegaEmbed('#vis', spec, options)
        .then(result =>
          console.log('Vega view instantiated with custom action handlers:', result.view)
        )
        .catch(console.error);
    </script>
  </body>
</html>
