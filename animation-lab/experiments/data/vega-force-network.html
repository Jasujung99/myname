<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vega 힘-방향 네트워크 시각화</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vega Libraries from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .control-panel label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .control-panel input[type="range"] {
            width: 60%;
        }
        .control-panel input[type="checkbox"] {
            width: 1.5rem;
            height: 1.5rem;
        }
        .tooltip {
            position: absolute;
            visibility: hidden;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 0.875rem;
            line-height: 1.25rem;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">인터랙티브 Vega 힘-방향 네트워크</h1>
            <p class="text-md text-gray-600 mt-2">제어판을 조작하여 네트워크 시뮬레이션의 변화를 관찰해보세요.</p>
        </header>

        <div class="flex flex-col md:flex-row gap-8">
            <!-- Control Panel -->
            <aside class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-6 border-b pb-3">시뮬레이션 제어판</h2>
                <div id="controls" class="space-y-6 control-panel">
                    <div>
                        <label for="static" class="font-semibold text-gray-700">
                            <span>정적 모드</span>
                            <input type="checkbox" id="static" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </label>
                    </div>
                    <div>
                        <label for="charge" class="font-semibold text-gray-700">
                            <span>척력(Charge)</span>
                            <span id="charge-value" class="font-mono text-sm text-indigo-600">-30</span>
                        </label>
                        <input type="range" id="charge" min="-200" max="0" value="-30" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="link-distance" class="font-semibold text-gray-700">
                            <span>연결 거리</span>
                            <span id="link-distance-value" class="font-mono text-sm text-indigo-600">30</span>
                        </label>
                        <input type="range" id="link-distance" min="5" max="150" value="30" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                     <div>
                        <label for="link-strength" class="font-semibold text-gray-700">
                             <span>연결 강도</span>
                             <span id="link-strength-value" class="font-mono text-sm text-indigo-600">0.1</span>
                        </label>
                        <input type="range" id="link-strength" min="0" max="1" value="0.1" step="0.01" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="collide" class="font-semibold text-gray-700">
                            <span>충돌 반경</span>
                            <span id="collide-value" class="font-mono text-sm text-indigo-600">8</span>
                        </label>
                        <input type="range" id="collide" min="0" max="20" value="8" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="pt-4">
                        <button id="restart-button" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                            시뮬레이션 재시작
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Visualization Area -->
            <main class="w-full md:w-2/3 lg:w-3/4 bg-white rounded-xl shadow-lg p-2">
                <div id="vis" class="w-full h-[600px] md:h-full"></div>
            </main>
        </div>
    </div>
    
    <!-- Tooltip Element -->
    <div id="vg-tooltip-element" class="tooltip"></div>


    <script>
        // 전역 Vega View 객체
        let vegaView;

        // Vega Spec (JSON 형식)
        const vegaSpec = {
            "$schema": "https://vega.github.io/schema/vega/v5.json",
            "description": "A force-directed layout of character co-occurrences in Les Misérables.",
            "width": 700,
            "height": 500,
            "padding": 0,
            "autosize": { "type": "fit", "contains": "padding" },

            // 시뮬레이션 제어를 위한 시그널(Signal) 정의
            "signals": [
                { "name": "tooltip", "value": {}, "on": [
                    { "events": "symbol:mouseover", "update": "datum" },
                    { "events": "symbol:mouseout", "update": "{}" }
                ]},
                { "name": "nodeCharge", "value": -30, "bind": { "input": "range", "min": -200, "max": 10, "step": 1 } },
                { "name": "linkDistance", "value": 30, "bind": { "input": "range", "min": 5, "max": 150, "step": 1 } },
                { "name": "linkStrength", "value": 0.1, "bind": {"input": "range", "min": 0, "max": 1, "step": 0.01}},
                { "name": "nodeCollide", "value": 8, "bind": { "input": "range", "min": 0, "max": 20, "step": 0.5 } },
                { "name": "isStatic", "value": false, "bind": { "input": "checkbox" } }
            ],

            // 데이터 로딩
            "data": [
                {
                    "name": "nodes",
                    "url": "https://raw.githubusercontent.com/vega/vega-datasets/main/data/miserables.json",
                    "format": { "type": "json", "property": "nodes" },
                    // *** FIX: Moved force transform here to ensure nodes have x/y before links are drawn ***
                    "transform": [
                        {
                            "type": "force",
                            "iterations": 300,
                            "static": { "signal": "isStatic" },
                            "restart": { "signal": "isStatic" },
                            "forces": [
                                { "force": "center", "x": { "signal": "width / 2" }, "y": { "signal": "height / 2" } },
                                { "force": "collide", "radius": { "signal": "nodeCollide" } },
                                { "force": "nbody", "strength": { "signal": "nodeCharge" } },
                                { "force": "link", "links": "links", "distance": { "signal": "linkDistance" }, "strength": {"signal": "linkStrength"} }
                            ]
                        }
                    ]
                },
                {
                    "name": "links",
                    "url": "https://raw.githubusercontent.com/vega/vega-datasets/main/data/miserables.json",
                    "format": { "type": "json", "property": "links" }
                }
            ],
            
            // 색상 스케일
            "scales": [
                {
                    "name": "color",
                    "type": "ordinal",
                    "domain": { "data": "nodes", "field": "group" },
                    "range": { "scheme": "category20c" }
                }
            ],

            // 시각적 요소(Marks) 정의
            "marks": [
                {
                    "name": "node-marks",
                    "type": "symbol",
                    "from": { "data": "nodes" },
                    "encode": {
                        "enter": {
                           "fill": { "scale": "color", "field": "group" },
                           "stroke": { "value": "white" }
                        },
                        "update": {
                           "size": { "value": 150 },
                           "cursor": {"value": "pointer"}
                        }
                    }
                    // *** FIX: Removed transform from here ***
                },
                {
                    "type": "path",
                    "from": { "data": "links" },
                    "interactive": false,
                    "encode": {
                        "update": {
                            "stroke": { "value": "#ccc" },
                            "strokeWidth": { "value": 0.5 }
                        }
                    },
                    // 링크의 시작점과 끝점을 노드 위치와 연결
                    "transform": [
                        {
                            "type": "linkpath",
                            "sourceX": "source.x", "sourceY": "source.y",
                            "targetX": "target.x", "targetY": "target.y",
                            "shape": "line"
                        }
                    ]
                }
            ]
        };

        // UI 컨트롤과 Vega 시그널 연결
        function setupControls() {
            const chargeSlider = document.getElementById('charge');
            const chargeValue = document.getElementById('charge-value');
            const distanceSlider = document.getElementById('link-distance');
            const distanceValue = document.getElementById('link-distance-value');
            const strengthSlider = document.getElementById('link-strength');
            const strengthValue = document.getElementById('link-strength-value');
            const collideSlider = document.getElementById('collide');
            const collideValue = document.getElementById('collide-value');
            const staticCheckbox = document.getElementById('static');
            const restartButton = document.getElementById('restart-button');

            // 초기 값 설정
            chargeSlider.value = vegaSpec.signals.find(s => s.name === 'nodeCharge').value;
            chargeValue.textContent = chargeSlider.value;
            distanceSlider.value = vegaSpec.signals.find(s => s.name === 'linkDistance').value;
            distanceValue.textContent = distanceSlider.value;
            strengthSlider.value = vegaSpec.signals.find(s => s.name === 'linkStrength').value;
            strengthValue.textContent = strengthSlider.value;
            collideSlider.value = vegaSpec.signals.find(s => s.name === 'nodeCollide').value;
            collideValue.textContent = collideSlider.value;
            staticCheckbox.checked = vegaSpec.signals.find(s => s.name === 'isStatic').value;

            // 이벤트 리스너 추가
            chargeSlider.addEventListener('input', (e) => {
                const value = +e.target.value;
                chargeValue.textContent = value;
                vegaView.signal('nodeCharge', value).runAsync();
            });

            distanceSlider.addEventListener('input', (e) => {
                const value = +e.target.value;
                distanceValue.textContent = value;
                vegaView.signal('linkDistance', value).runAsync();
            });
            
            strengthSlider.addEventListener('input', (e) => {
                const value = +e.target.value;
                strengthValue.textContent = value;
                vegaView.signal('linkStrength', value).runAsync();
            });

            collideSlider.addEventListener('input', (e) => {
                const value = +e.target.value;
                collideValue.textContent = value;
                vegaView.signal('nodeCollide', value).runAsync();
            });

            staticCheckbox.addEventListener('change', (e) => {
                const checked = e.target.checked;
                vegaView.signal('isStatic', checked).runAsync();
            });
            
            restartButton.addEventListener('click', () => {
                // 재시작을 위해 static 시그널을 잠시 false로 했다가 다시 원래 값으로 변경
                const isStatic = staticCheckbox.checked;
                if (isStatic) {
                    vegaView.signal('isStatic', false).runAsync();
                    // 약간의 딜레이 후 원래 상태로 복귀
                    setTimeout(() => vegaView.signal('isStatic', true).runAsync(), 50);
                } else {
                     // 이미 애니메이션 중이면 force transform을 재실행
                     vegaView.changeset().touch(vegaView.data('nodes')).runAsync();
                }
            });
        }

        // 툴팁 핸들러
        const tooltipHandler = function(event, item) {
            const tooltip = document.getElementById('vg-tooltip-element');
            if (item && item.datum && item.datum.name) {
                tooltip.style.visibility = 'visible';
                tooltip.style.left = event.pageX + 10 + 'px';
                tooltip.style.top = event.pageY + 10 + 'px';
                tooltip.innerHTML = `<b>${item.datum.name}</b><br>Group: ${item.datum.group}`;
            } else {
                tooltip.style.visibility = 'hidden';
            }
        };

        // Vega 렌더링
        vegaEmbed('#vis', vegaSpec, {
            actions: false, // 기본 액션 버튼 숨기기
            renderer: 'canvas', // 렌더러 설정 (svg 또는 canvas)
            tooltip: tooltipHandler // 커스텀 툴팁 핸들러 등록
        })
        .then(result => {
            vegaView = result.view;
            setupControls();
        })
        .catch(console.error);

    </script>
</body>
</html>
```

I made some changes. I moved the force simulation logic from the visual marks definition to the data processing definition. This change ensures that the node positions are calculated before the links are drawn, which resolves the err