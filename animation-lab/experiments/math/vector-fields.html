<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²¡í„°ì¥ ì‹œê°í™” - Animation Lab</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0F4C75 0%, #3282B8 50%, #0F3460 100%);
            color: white;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .canvas-area {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0.4) 100%);
        }

        #mainCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #vegaFieldStats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 2;
            pointer-events: none;
            background: rgba(0,0,0,0.8);
            border-radius: 12px;
            padding: 20px 25px 40px 25px;
            width: 380px;
            height: 290px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        .control-panel {
            width: 380px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .experiment-title {
            font-size: 1.4rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            color: #3282B8;
        }

        .experiment-desc {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
            margin-bottom: 20px;
        }

        .field-selector {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .field-selector h3 {
            margin-bottom: 15px;
            color: #3282B8;
            font-size: 1.1rem;
        }

        .field-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .field-btn {
            background: rgba(50, 130, 184, 0.2);
            border: 1px solid rgba(50, 130, 184, 0.4);
            color: white;
            padding: 10px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-align: center;
        }

        .field-btn:hover {
            background: rgba(50, 130, 184, 0.4);
            transform: translateY(-1px);
        }

        .field-btn.active {
            background: rgba(50, 130, 184, 0.6);
            border-color: #3282B8;
        }

        .control-group {
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #3282B8;
            font-size: 1.1rem;
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3282B8;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .value-display {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            min-width: 50px;
            text-align: center;
        }

        .animation-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .anim-btn {
            flex: 1;
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .anim-btn:hover {
            background: rgba(76, 175, 80, 0.5);
            transform: translateY(-1px);
        }

        .anim-btn.active {
            background: rgba(76, 175, 80, 0.7);
        }

        .learning-section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .learning-section h3 {
            margin-bottom: 15px;
            color: #FF6B6B;
            font-size: 1.1rem;
        }

        .concept-item {
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            border-left: 3px solid #FF6B6B;
        }

        .concept-item h4 {
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #FFB74D;
        }

        .concept-item p {
            font-size: 0.8rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                max-height: 40vh;
                order: -1;
            }
            
            .canvas-area {
                flex: 1;
                min-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="canvas-area">
            <canvas id="mainCanvas"></canvas>
            <div id="vegaFieldStats"></div>
        </div>
        
        <div class="control-panel">
            <div class="nav-header">
                <a href="../../index.html" class="back-btn">â† ëŒì•„ê°€ê¸°</a>
            </div>
            
            <div class="experiment-title">ğŸ“ ë²¡í„°ì¥ ì‹œê°í™”</div>
            <div class="experiment-desc">ê·¸ë˜ë””ì–¸íŠ¸, ë°œì‚°, íšŒì „ í•„ë“œì˜ íë¦„ì„ ì§ê´€ì ìœ¼ë¡œ ì‹œê°í™”</div>
            
            <div class="field-selector">
                <h3>ğŸ¯ ë²¡í„°ì¥ ìœ í˜•</h3>
                <div class="field-buttons">
                    <button class="field-btn active" data-field="gradient">ê·¸ë˜ë””ì–¸íŠ¸</button>
                    <button class="field-btn" data-field="divergence">ë°œì‚°</button>
                    <button class="field-btn" data-field="curl">íšŒì „</button>
                    <button class="field-btn" data-field="uniform">ê· ë“±</button>
                    <button class="field-btn" data-field="saddle">ìƒˆë“¤ì </button>
                    <button class="field-btn" data-field="wave">íŒŒë™</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>ğŸ“Š ì‹¤ì‹œê°„ ë¶„ì„</h3>
                <div class="control-item">
                    <label>í˜„ì¬ í•„ë“œ ì •ë³´</label>
                    <div id="fieldInfo" class="value-display" style="width: 100%; margin-top: 5px; padding: 8px; background: rgba(255,255,255,0.1)">
                        ë¶„ì„ ì¤‘...
                    </div>
                </div>
                <div class="control-item">
                    <label>í™œì„± ì…ì ìˆ˜</label>
                    <div class="slider-container">
                        <div class="value-display" id="activeParticles" style="background: rgba(76, 175, 80, 0.3)">0</div>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <h3>ï¿½ íë¦„ ì‹œê°í™”</h3>
                <div class="control-item">
                    <label>ê°•ë„ (Strength)</label>
                    <div class="slider-container">
                        <input type="range" id="strength" min="0.1" max="3.0" step="0.1" value="1.0">
                        <div class="value-display" id="strengthValue">1.0</div>
                    </div>
                </div>
                <div class="control-item">
                    <label>ì…ì ìˆ˜</label>
                    <div class="slider-container">
                        <input type="range" id="particleCount" min="50" max="500" step="25" value="200">
                        <div class="value-display" id="particleCountValue">200</div>
                    </div>
                </div>
                <div class="control-item">
                    <label>íë¦„ ì†ë„</label>
                    <div class="slider-container">
                        <input type="range" id="flowSpeed" min="0.1" max="2.0" step="0.1" value="0.1">
                        <div class="value-display" id="flowSpeedValue">0.1</div>
                    </div>
                </div>
                <div class="animation-controls">
                    <button class="anim-btn" id="playPause">â¸ï¸ ì¼ì‹œì •ì§€</button>
                    <button class="anim-btn" id="reset">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="learning-section">
                <h3>ğŸ“š í•™ìŠµ ê°€ì´ë“œ</h3>
                
                <div class="concept-item">
                    <h4>ğŸ“Š ë²¡í„° ê°•ë„ ë¶„í¬ íˆìŠ¤í† ê·¸ë¨</h4>
                    <p>í™”ë©´ ì¢Œí•˜ë‹¨ì˜ íˆìŠ¤í† ê·¸ë¨ì€ ë²¡í„°ì¥ì˜ ê°•ë„ ë¶„í¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. Xì¶•ì€ ë²¡í„°ì˜ í¬ê¸°(ê°•ë„), Yì¶•ì€ í•´ë‹¹ ê°•ë„ë¥¼ ê°€ì§„ ë²¡í„°ì˜ ê°œìˆ˜ì…ë‹ˆë‹¤. ë²¡í„°ì¥ ìœ í˜•ì„ ë°”ê¾¸ë©´ ë¶„í¬ íŒ¨í„´ì´ ì¦‰ì‹œ ë³€í™”í•˜ëŠ” ê²ƒì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸŒŠ ê·¸ë˜ë””ì–¸íŠ¸ (Gradient)</h4>
                    <p>ìŠ¤ì¹¼ë¼ í•¨ìˆ˜ f(x,y) = xÂ² + yÂ²ì˜ ê·¸ë˜ë””ì–¸íŠ¸ âˆ‡f = (2x, 2y)ì…ë‹ˆë‹¤. ì¤‘ì‹¬ì—ì„œ ë°”ê¹¥ìª½ìœ¼ë¡œ ë°œì‚°í•˜ëŠ” ë°©ì‚¬í˜• íŒ¨í„´ì„ ë³´ì…ë‹ˆë‹¤. íˆìŠ¤í† ê·¸ë¨ì—ì„œëŠ” ì¤‘ì‹¬ ê·¼ì²˜ì˜ ë‚®ì€ ê°•ë„ë¶€í„° ê°€ì¥ìë¦¬ì˜ ë†’ì€ ê°•ë„ê¹Œì§€ ê³ ë¥¸ ë¶„í¬ë¥¼ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸ“ˆ ë°œì‚° (Divergence)</h4>
                    <p>div F = âˆ‚Fx/âˆ‚x + âˆ‚Fy/âˆ‚y = 2ë¡œ ê³„ì‚°ë˜ëŠ” ì–‘ì˜ ë°œì‚°ì¥ì…ë‹ˆë‹¤. ëª¨ë“  ì ì—ì„œ ë°”ê¹¥ìª½ìœ¼ë¡œ ë°œì‚°í•˜ë©°, ì¤‘ì‹¬ì´ ì†ŒìŠ¤(source) ì—­í• ì„ í•©ë‹ˆë‹¤. íˆìŠ¤í† ê·¸ë¨ì€ ê±°ë¦¬ì— ë”°ë¼ ì„ í˜•ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” ê°•ë„ ë¶„í¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸŒ€ íšŒì „ (Curl)</h4>
                    <p>F = (-y, x) í˜•íƒœì˜ íšŒì „ì¥ìœ¼ë¡œ, 2D curl = âˆ‚Fy/âˆ‚x - âˆ‚Fx/âˆ‚y = 2ì…ë‹ˆë‹¤. ë°˜ì‹œê³„ë°©í–¥ìœ¼ë¡œ íšŒì „í•˜ëŠ” íŒ¨í„´ì„ ë³´ì´ë©°, íˆìŠ¤í† ê·¸ë¨ì—ì„œëŠ” ì¤‘ì‹¬ì—ì„œ ë©€ì–´ì§ˆìˆ˜ë¡ ê°•ë„ê°€ ì¦ê°€í•˜ëŠ” ë¶„í¬ë¥¼ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>âš¡ ê· ë“± (Uniform)</h4>
                    <p>F = (1, 0) í˜•íƒœì˜ ê· ë“±í•œ ë²¡í„°ì¥ì…ë‹ˆë‹¤. ëª¨ë“  ì ì—ì„œ ë™ì¼í•œ ë°©í–¥ê³¼ í¬ê¸°ë¥¼ ê°€ì§€ë¯€ë¡œ, íˆìŠ¤í† ê·¸ë¨ì—ì„œëŠ” ë‹¨ì¼ ê°•ë„ê°’ì— ëª¨ë“  ë²¡í„°ê°€ ì§‘ì¤‘ë˜ëŠ” ë§¤ìš° ì¢ì€ ë¶„í¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸ¯ ìƒˆë“¤ì  (Saddle Point)</h4>
                    <p>F = (x, -y) í˜•íƒœë¡œ, í•œ ì¶•ìœ¼ë¡œëŠ” ë°œì‚°í•˜ê³  ë‹¤ë¥¸ ì¶•ìœ¼ë¡œëŠ” ìˆ˜ë ´í•˜ëŠ” ë¶ˆì•ˆì •í•œ í‰í˜•ì ì…ë‹ˆë‹¤. íˆìŠ¤í† ê·¸ë¨ì—ì„œëŠ” ì¤‘ì‹¬ ê·¼ì²˜ì˜ ë‚®ì€ ê°•ë„ì™€ ëŒ€ê°ì„  ë°©í–¥ì˜ ë†’ì€ ê°•ë„ë¡œ ì´ë£¨ì–´ì§„ ì´ì¤‘ ë¶„í¬ íŒ¨í„´ì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸŒŠ íŒŒë™ (Wave)</h4>
                    <p>F = (sin(x + t), cos(y + t)) í˜•íƒœì˜ ì‹œê°„ ì˜ì¡´ì  íŒŒë™ì¥ì…ë‹ˆë‹¤. ì‹œê°„ì— ë”°ë¼ ë²¡í„°ì˜ ë°©í–¥ê³¼ í¬ê¸°ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ë³€í™”í•˜ë©°, íˆìŠ¤í† ê·¸ë¨ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í™”í•˜ëŠ” ëª¨ìŠµì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸ® ì‹¤í—˜ íŒ</h4>
                    <p>â€¢ <strong>ë²¡í„°ì¥ ë¹„êµ:</strong> ì„œë¡œ ë‹¤ë¥¸ í•„ë“œ ê°„ ì „í™˜í•˜ì—¬ íˆìŠ¤í† ê·¸ë¨ ë¶„í¬ íŒ¨í„´ ë¹„êµ<br>
                    â€¢ <strong>ê°•ë„ ì¡°ì ˆ:</strong> ìŠ¬ë¼ì´ë”ë¡œ ê°•ë„ë¥¼ ë³€í™”ì‹œì¼œ íˆìŠ¤í† ê·¸ë¨ ìŠ¤ì¼€ì¼ë§ íš¨ê³¼ ê´€ì°°<br>
                    â€¢ <strong>ì‹¤ì‹œê°„ ë¶„ì„:</strong> íŒŒë™ í•„ë“œì—ì„œ ì‹œê°„ì— ë”°ë¥¸ ë¶„í¬ ë³€í™” ê´€ì°°<br>
                    â€¢ <strong>ì…ì ì¶”ì :</strong> ì…ìì˜ ê¶¤ì ì„ í†µí•´ ë²¡í„°ì¥ì˜ ê¸°í•˜í•™ì  ì„±ì§ˆ íŒŒì•…</p>
                </div>

                <div class="concept-item">
                    <h4>ğŸ”¬ ë¬¼ë¦¬í•™ì  ì‘ìš©</h4>
                    <p>â€¢ <strong>ì „ê¸°ì¥:</strong> ê·¸ë˜ë””ì–¸íŠ¸ í•„ë“œë¡œ ì „ìœ„ ë¶„í¬ ì‹œê°í™”<br>
                    â€¢ <strong>ìœ ì²´ì—­í•™:</strong> ë°œì‚°ìœ¼ë¡œ ì••ì¶•ì„±, íšŒì „ìœ¼ë¡œ ì™€ë¥˜ ë¶„ì„<br>
                    â€¢ <strong>ì—­í•™ê³„:</strong> ìƒˆë“¤ì ìœ¼ë¡œ ë¶ˆì•ˆì •í•œ í‰í˜•ìƒíƒœ ì´í•´<br>
                    â€¢ <strong>íŒŒë™í˜„ìƒ:</strong> ì‹œê°„ ì˜ì¡´ì  í•„ë“œë¡œ íŒŒë™ ì „íŒŒ ê´€ì°°</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ì„¤ì • ìƒìˆ˜ë“¤
        const CONFIG = {
            VECTOR_DENSITY: 20,
            ARROW_SHAFT_LENGTH: 0,
            PARTICLE_TRAIL_MAX: 15,
            PARTICLE_LIFE_MIN: 500,
            PARTICLE_LIFE_MAX: 1500,
            CANVAS_UPDATE_RATE: 60, // FPS
            VEGA_UPDATE_RATE: 30,   // 30í”„ë ˆì„ë§ˆë‹¤ Vega ì—…ë°ì´íŠ¸ (ë” ë¹ ë¥¸ ë°˜ì‘)
            INFO_UPDATE_RATE: 30,   // 30í”„ë ˆì„ë§ˆë‹¤ ì •ë³´ ì—…ë°ì´íŠ¸
            COLORS: {
                ARROW_SHAFT: 'rgba(50, 130, 184, 0.5)',
                ARROW_HEAD: 'rgba(50, 130, 184, 0.8)',
                PARTICLE_BASE: 200,
                PARTICLE_RANGE: 160
            }
        };

        // ë²¡í„° í•„ë“œ ê³„ì‚° í´ë˜ìŠ¤
        class VectorFieldMath {
            static getVectorAt(x, y, centerX, centerY, fieldType, strength, time) {
                const nx = (x - centerX) / 100;
                const ny = (y - centerY) / 100;
                const t = time * 0.02;
                
                const fieldFunctions = {
                    gradient: () => this.gradientField(nx, ny, strength),
                    divergence: () => this.divergenceField(nx, ny, strength),
                    curl: () => this.curlField(nx, ny, strength),
                    uniform: () => this.uniformField(strength),
                    saddle: () => this.saddleField(nx, ny, strength),
                    wave: () => this.waveField(nx, ny, t, strength)
                };
                
                return fieldFunctions[fieldType]?.() || { x: 0, y: 0 };
            }
            
            static gradientField(nx, ny, strength) {
                const dist = Math.sqrt(nx * nx + ny * ny);
                if (dist === 0) return { x: 0, y: 0 };
                return {
                    x: (nx / dist) * strength,
                    y: (ny / dist) * strength
                };
            }
            
            static divergenceField(nx, ny, strength) {
                return { x: nx * strength, y: ny * strength };
            }
            
            static curlField(nx, ny, strength) {
                return { x: -ny * strength, y: nx * strength };
            }
            
            static uniformField(strength) {
                return { x: strength, y: 0 };
            }
            
            static saddleField(nx, ny, strength) {
                return { x: nx * strength, y: -ny * strength };
            }
            
            static waveField(nx, ny, t, strength) {
                return {
                    x: Math.sin(ny * 2 + t) * strength,
                    y: Math.cos(nx * 2 + t) * strength
                };
            }
        }

        // ì…ì ì‹œìŠ¤í…œ í´ë˜ìŠ¤
        class ParticleSystem {
            constructor(width, height) {
                this.width = width;
                this.height = height;
                this.particles = [];
            }
            
            initParticles(count) {
                this.particles = [];
                for (let i = 0; i < count; i++) {
                    this.particles.push(this.createParticle());
                }
            }
            
            createParticle() {
                return {
                    x: Math.random() * this.width,
                    y: Math.random() * this.height,
                    trail: [],
                    color: `hsl(${CONFIG.COLORS.PARTICLE_BASE + Math.random() * CONFIG.COLORS.PARTICLE_RANGE}, 70%, 60%)`,
                    life: Math.random() * (CONFIG.PARTICLE_LIFE_MAX - CONFIG.PARTICLE_LIFE_MIN) + CONFIG.PARTICLE_LIFE_MIN
                };
            }
            
            updateParticles(getVectorAt, flowSpeed, isAnimating) {
                if (!isAnimating) return;
                
                this.particles.forEach(particle => {
                    const vector = getVectorAt(particle.x, particle.y);
                    
                    // ê¶¤ì  ì €ì¥
                    particle.trail.push({ x: particle.x, y: particle.y });
                    if (particle.trail.length > CONFIG.PARTICLE_TRAIL_MAX) {
                        particle.trail.shift();
                    }
                    
                    // ì…ì ì´ë™
                    particle.x += vector.x * flowSpeed * 10;
                    particle.y += vector.y * flowSpeed * 10;
                    
                    // ê²½ê³„ ì²˜ë¦¬ ë° ìƒëª…ì£¼ê¸° ê´€ë¦¬
                    this.handleParticleBounds(particle);
                });
            }
            
            handleParticleBounds(particle) {
                const outOfBounds = particle.x < 0 || particle.x > this.width || 
                                   particle.y < 0 || particle.y > this.height;
                
                particle.life--;
                
                if (outOfBounds || particle.life <= 0) {
                    Object.assign(particle, this.createParticle());
                }
            }
            
            draw(ctx) {
                this.particles.forEach(particle => {
                    this.drawParticleTrail(ctx, particle);
                    this.drawParticle(ctx, particle);
                });
                ctx.globalAlpha = 1.0;
            }
            
            drawParticleTrail(ctx, particle) {
                if (particle.trail.length <= 1) return;
                
                ctx.strokeStyle = particle.color + '80';
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.6;
                
                ctx.beginPath();
                particle.trail.forEach((point, i) => {
                    if (i === 0) {
                        ctx.moveTo(point.x, point.y);
                    } else {
                        ctx.lineTo(point.x, point.y);
                    }
                });
                ctx.stroke();
            }
            
            drawParticle(ctx, particle) {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = 1.0;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            getActiveCount() {
                return this.particles.filter(p => p.life > 0).length;
            }
        }

        // ë©”ì¸ ì‹œê°í™” í´ë˜ìŠ¤
        class VectorFieldVisualizer {
            constructor() {
                this.canvas = document.getElementById('mainCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.params = {
                    fieldType: 'gradient',
                    strength: 1.0,
                    particleCount: 200,
                    flowSpeed: 0.1,
                    isAnimating: true
                };
                
                this.vectorData = [];
                this.fieldData = [];
                this.time = 0;
                this.animationId = null;
                this.vegaCharts = {
                    fieldStats: null
                };
                
                this.particleSystem = null;
                
                this.init();
            }
            
            init() {
                this.initCanvas();
                this.setupControls();
                this.setupFieldButtons();
                this.initVegaCharts();
                this.animate();
            }
            
            initCanvas() {
                const resizeCanvas = () => {
                    const canvasArea = document.querySelector('.canvas-area');
                    const rect = canvasArea.getBoundingClientRect();
                    const dpr = window.devicePixelRatio || 1;
                    
                    this.canvas.width = rect.width * dpr;
                    this.canvas.height = rect.height * dpr;
                    this.canvas.style.width = rect.width + 'px';
                    this.canvas.style.height = rect.height + 'px';
                    
                    this.ctx.scale(dpr, dpr);
                    
                    this.width = rect.width;
                    this.height = rect.height;
                    this.centerX = this.width / 2;
                    this.centerY = this.height / 2;
                    
                    console.log(`Canvas resized to: ${this.width}x${this.height}`);
                    
                    this.generateVectorField();
                    this.initParticleSystem();
                };
                
                setTimeout(resizeCanvas, 100);
                window.addEventListener('resize', () => setTimeout(resizeCanvas, 100));
            }
            
            initParticleSystem() {
                this.particleSystem = new ParticleSystem(this.width, this.height);
                this.particleSystem.initParticles(this.params.particleCount);
            }
            
            setupControls() {
                const controlConfig = [
                    { param: 'strength', element: 'strength', display: 'strengthValue' },
                    { param: 'particleCount', element: 'particleCount', display: 'particleCountValue' },
                    { param: 'flowSpeed', element: 'flowSpeed', display: 'flowSpeedValue' }
                ];
                
                controlConfig.forEach(config => {
                    const element = document.getElementById(config.element);
                    const display = document.getElementById(config.display);
                    
                    element.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.params[config.param] = value;
                        display.textContent = value;
                        
                        if (config.param === 'particleCount') {
                            this.particleSystem?.initParticles(value);
                        }
                        
                        // íŒŒë¼ë¯¸í„° ë³€ê²½ ì‹œ ì¦‰ì‹œ íˆìŠ¤í† ê·¸ë¨ ì—…ë°ì´íŠ¸
                        this.onParameterChange();
                    });
                    
                    display.textContent = element.value;
                });
                
                this.setupAnimationControls();
            }
            
            setupAnimationControls() {
                const playPauseBtn = document.getElementById('playPause');
                const resetBtn = document.getElementById('reset');
                
                playPauseBtn.addEventListener('click', () => {
                    this.params.isAnimating = !this.params.isAnimating;
                    playPauseBtn.textContent = this.params.isAnimating ? 'â¸ï¸ ì¼ì‹œì •ì§€' : 'â–¶ï¸ ì¬ìƒ';
                    playPauseBtn.classList.toggle('active', this.params.isAnimating);
                });
                
                resetBtn.addEventListener('click', () => {
                    this.particleSystem?.initParticles(this.params.particleCount);
                    this.time = 0;
                });
            }
            
            setupFieldButtons() {
                const buttons = document.querySelectorAll('.field-btn');
                
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.setActiveField(button, buttons);
                        this.params.fieldType = button.dataset.field;
                        
                        // ì¦‰ì‹œ ë²¡í„° í•„ë“œ ì¬ìƒì„± ë° íˆìŠ¤í† ê·¸ë¨ ì—…ë°ì´íŠ¸
                        console.log(`ë²¡í„°ì¥ ìœ í˜• ë³€ê²½: ${this.params.fieldType}`);
                        this.onFieldChange();
                        
                        // ì¶”ê°€ë¡œ ê°•ì œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                        setTimeout(() => {
                            this.updateFieldStatsChart();
                            console.log('ë²¡í„°ì¥ ë³€ê²½ í›„ íˆìŠ¤í† ê·¸ë¨ ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                        }, 50);
                    });
                });
            }
            
            setActiveField(activeButton, allButtons) {
                allButtons.forEach(b => b.classList.remove('active'));
                activeButton.classList.add('active');
            }
            
            onFieldChange() {
                console.log('ë²¡í„° í•„ë“œ ë³€ê²½ ì‹œì‘...');
                
                // ë²¡í„° í•„ë“œ ì¦‰ì‹œ ì¬ìƒì„±
                this.generateVectorField();
                this.particleSystem?.initParticles(this.params.particleCount);
                
                // íˆìŠ¤í† ê·¸ë¨ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë‘ ë²ˆ í˜¸ì¶œë¡œ í™•ì‹¤íˆ)
                this.updateVegaCharts();
                this.updateFieldStatsChart();
                
                console.log('ë²¡í„° í•„ë“œ ë³€ê²½ ì™„ë£Œ');
            }
            
            getVectorAt(x, y) {
                return VectorFieldMath.getVectorAt(
                    x, y, this.centerX, this.centerY, 
                    this.params.fieldType, this.params.strength, this.time
                );
            }
            
            generateVectorField() {
                this.vectorData = [];
                this.fieldData = [];
                
                const step = Math.max(this.width, this.height) / CONFIG.VECTOR_DENSITY;
                
                for (let x = step; x < this.width; x += step) {
                    for (let y = step; y < this.height; y += step) {
                        const vector = this.getVectorAt(x, y);
                        const magnitude = Math.sqrt(vector.x * vector.x + vector.y * vector.y);
                        
                        this.vectorData.push({
                            x, y,
                            vx: vector.x,
                            vy: vector.y,
                            magnitude,
                            angle: Math.atan2(vector.y, vector.x) * 180 / Math.PI
                        });
                        
                        this.fieldData.push({ x, y, value: magnitude });
                    }
                }
            }
            
            // ê°œì„ ëœ ì•ˆì „í•œ ë°ì´í„° ìƒì„± (ë”ë¯¸ ë°ì´í„° ìµœì†Œí™”)
            generateSafeFieldData() {
                // ë²¡í„° ë°ì´í„°ê°€ ì—†ì„ ë•Œë§Œ ë”ë¯¸ ë°ì´í„° ì‚¬ìš© (ìµœì´ˆ ì´ˆê¸°í™” ì‹œì—ë§Œ)
                if (!this.vectorData || this.vectorData.length === 0) {
                    console.log('ë²¡í„° ë°ì´í„°ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return [{value: 0, magnitude: 0}]; // ìµœì´ˆì—ë§Œ ë”ë¯¸ ë°ì´í„°
                }
                
                const fieldData = [];
                for (const vector of this.vectorData) {
                    if (vector && typeof vector.magnitude === 'number' && 
                        !isNaN(vector.magnitude) && isFinite(vector.magnitude)) {
                        fieldData.push({
                            magnitude: vector.magnitude // ì¤‘ë³µ ì œê±°, magnitudeë§Œ ì‚¬ìš©
                        });
                    }
                }
                
                // ì‹¤ì œ ë²¡í„° ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ì‚¬ìš© (ë”ë¯¸ ë°ì´í„° ì‚¬ìš© ì•ˆí•¨)
                if (fieldData.length === 0 && this.vectorData.length > 0) {
                    console.log('ë²¡í„° ë°ì´í„°ëŠ” ìˆì§€ë§Œ ìœ íš¨í•˜ì§€ ì•ŠìŒ. ê¸°ë³¸ê°’ìœ¼ë¡œ ì²˜ë¦¬');
                    // ì‹¤ì œ ë²¡í„° ë°ì´í„°ì—ì„œ ê°•ì œë¡œ ì¶”ì¶œ
                    return this.vectorData.map(v => ({
                        magnitude: Math.sqrt((v.vx || 0) * (v.vx || 0) + (v.vy || 0) * (v.vy || 0))
                    }));
                }
                
                console.log(`ì‹¤ì œ í•„ë“œ ë°ì´í„° ${fieldData.length}ê°œ ìƒì„±ë¨`);
                return fieldData;
            }
            
            drawVectorShafts() {
                this.ctx.strokeStyle = CONFIG.COLORS.ARROW_SHAFT;
                this.ctx.lineWidth = 1.5;
                
                this.vectorData.forEach(data => {
                    const dx = data.vx * CONFIG.ARROW_SHAFT_LENGTH;
                    const dy = data.vy * CONFIG.ARROW_SHAFT_LENGTH;
                    
                    if (Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) {
                        this.drawArrowShaft(data.x, data.y, dx, dy);
                    }
                });
            }
            
            drawArrowShaft(x, y, dx, dy) {
                const length = Math.sqrt(dx * dx + dy * dy);
                if (length < 1) return;
                
                this.ctx.beginPath();
                this.ctx.moveTo(x, y);
                this.ctx.lineTo(x + dx, y + dy);
                this.ctx.stroke();
            }
            
            draw() {
                if (!this.width || !this.height) return;
                
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                this.drawVectorShafts();
                
                this.particleSystem?.updateParticles(
                    (x, y) => this.getVectorAt(x, y),
                    this.params.flowSpeed,
                    this.params.isAnimating
                );
                this.particleSystem?.draw(this.ctx);
                
                // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
                if (this.time % CONFIG.INFO_UPDATE_RATE === 0) {
                    this.updateFieldInfo();
                }
            }
            
            initVegaCharts() {
                this.initFieldStatsChart();
            }
            
            initFieldStatsChart() {
                const spec = this.createFieldStatsSpec();
                this.initFieldStatsChartSafe('#vegaFieldStats', spec);
            }
            
            // ê°œì„ ëœ ì´ˆê¸°í™” - ë”ë¯¸ ë°ì´í„° ì˜ì¡´ì„± ìµœì†Œí™”
            async initFieldStatsChartSafe(selector, spec) {
                try {
                    console.log('fieldStats ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘...');
                    
                    const result = await vegaEmbed(selector, spec, {actions: false});
                    this.vegaCharts.fieldStats = result.view;
                    
                    console.log('fieldStats ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                    
                    // ì¦‰ì‹œ ì‹¤ì œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ ì‹œë„ (ë”ë¯¸ ë°ì´í„° ê±´ë„ˆë›°ê¸°)
                    if (this.vectorData && this.vectorData.length > 0) {
                        console.log('ì‹¤ì œ ë²¡í„° ë°ì´í„°ê°€ ì´ë¯¸ ì¤€ë¹„ë¨. ì¦‰ì‹œ ì—…ë°ì´íŠ¸');
                        this.updateFieldStatsChart();
                    } else {
                        // ë²¡í„° ë°ì´í„°ê°€ ì—†ì„ ë•Œë§Œ ë¹ˆ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                        this.vegaCharts.fieldStats.data('fieldData', []).run();
                        console.log('ë²¡í„° ë°ì´í„° ì¤€ë¹„ ëŒ€ê¸° ì¤‘...');
                        
                        // 50ms í›„ ì¬ì‹œë„ (ë¹ ë¥¸ ë°˜ì‘)
                        setTimeout(() => {
                            this.updateFieldStatsChart();
                        }, 50);
                    }
                    
                } catch (error) {
                    console.error('fieldStats ì°¨íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                }
            }
            
            // 3ë‹¨ê³„: í•„ë“œ ìŠ¤íƒ¯ ì°¨íŠ¸ë§Œì„ ìœ„í•œ ì•ˆì „í•œ ì—…ë°ì´íŠ¸
            updateFieldStatsChart() {
                if (!this.vegaCharts.fieldStats) {
                    console.log('fieldStats ì°¨íŠ¸ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const safeData = this.generateSafeFieldData();
                console.log('fieldStats ì°¨íŠ¸ ì—…ë°ì´íŠ¸:', safeData.length, 'ê°œ ë°ì´í„° í¬ì¸íŠ¸');
                
                try {
                    this.vegaCharts.fieldStats
                        .data('fieldData', safeData)
                        .run();
                    console.log('fieldStats ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì„±ê³µ');
                } catch (error) {
                    console.error('fieldStats ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                }
            }
            
            createFieldStatsSpec() {
                // ë” í° ì¹´ë“œì— ë§ê²Œ í¬ê¸° ë° ì¤‘ì•™ ì •ë ¬ ì¡°ì •
                return {
                    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                    "width": 330,
                    "height": 160,
                    "padding": {"left": 30, "top": 10, "right": 10, "bottom": 15},
                    "title": {
                        "text": "ë²¡í„° ê°•ë„ ë¶„í¬",
                        "color": "white",
                        "fontSize": 16,
                        "offset": 15,
                        "anchor": "middle"
                    },
                    "data": {"name": "fieldData"},
                    "mark": "bar",
                    "encoding": {
                        "x": {
                            "bin": {"maxbins": 8},
                            "field": "magnitude",
                            "type": "quantitative",
                            "title": " ",
                            "axis": {
                                "labelColor": "white",
                                "titleColor": "white",
                                "labelFontSize": 12,
                                "titleFontSize": 14
                            }
                        },
                        "y": {
                            "aggregate": "count",
                            "type": "quantitative",
                            "title": "ë¹ˆë„",
                            "axis": {
                                "labelColor": "white",
                                "titleColor": "white",
                                "labelFontSize": 12,
                                "titleFontSize": 14
                            }
                        }
                    },
                    "config": {
                        "background": "transparent",
                        "view": {"stroke": null},
                        "axis": {
                            "labelColor": "white",
                            "titleColor": "white",
                            "domainColor": "white",
                            "gridColor": "rgba(255,255,255,0.1)"
                        },
                        "title": {"color": "white"},
                        "bar": {
                            "color": "#3282B8",
                            "opacity": 0.85
                        }
                    }
                };
            }
            
            updateVegaCharts() {
                // 3ë‹¨ê³„: ì•ˆì „í•œ ì´ˆê¸°í™” ìˆœì„œ ë³´ì¥ - ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ ë°©ì‹ ì‚¬ìš©
                this.updateFieldStatsChart();
                this.updateFieldInfo();
            }
            
            updateFieldInfo() {
                if (!this.vectorData.length) return;
                
                const magnitudes = this.vectorData.map(d => d.magnitude);
                const stats = this.calculateFieldStats(magnitudes);
                const activeParticles = this.particleSystem?.getActiveCount() || 0;
                
                const info = `${this.getFieldDescription()} | í‰ê· : ${stats.avg.toFixed(2)} | ìµœëŒ€: ${stats.max.toFixed(2)}`;
                
                document.getElementById('fieldInfo').textContent = info;
                document.getElementById('activeParticles').textContent = activeParticles;
            }
            
            calculateFieldStats(magnitudes) {
                const sum = magnitudes.reduce((a, b) => a + b, 0);
                return {
                    avg: sum / magnitudes.length,
                    max: Math.max(...magnitudes),
                    min: Math.min(...magnitudes)
                };
            }
            
            getFieldDescription() {
                const descriptions = {
                    'gradient': 'âˆ‡f - ê·¸ë˜ë””ì–¸íŠ¸',
                    'divergence': 'âˆ‡Â·F - ë°œì‚°',
                    'curl': 'âˆ‡Ã—F - íšŒì „',
                    'uniform': 'F = const - ê· ë“±',
                    'saddle': 'Saddle - ìƒˆë“¤ì ',
                    'wave': 'Wave - íŒŒë™'
                };
                return descriptions[this.params.fieldType] || 'Unknown';
            }
            
            animate() {
                this.draw();
                
                if (this.params.isAnimating) {
                    this.time += 1;
                    
                    // Wave íƒ€ì…ì€ ë” ë¹ˆë²ˆí•œ íˆìŠ¤í† ê·¸ë¨ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë³€í™” ê°•ì¡°)
                    const updateRate = this.params.fieldType === 'wave' ? 
                        Math.floor(CONFIG.VEGA_UPDATE_RATE / 2) : CONFIG.VEGA_UPDATE_RATE;
                    
                    if (this.time % updateRate === 0) {
                        this.updateVegaCharts();
                    }
                }
                
                this.animationId = requestAnimationFrame(() => this.animate());
            }
        }
        
        // ì´ˆê¸°í™”
        let vectorField;
        window.addEventListener('load', () => {
            vectorField = new VectorFieldVisualizer();
        });
    </script>
</body>
</html>
